---
title: "Can We Predict How Many Reps You Have Left?"
subtitle: "Replicating Jukic et al. (2024) on RIR-Velocity Modeling"
author: "Deadlift Study Project"
date: today
format:
  html:
    toc: true
    toc-depth: 3
    code-fold: true
    code-summary: "Show code"
    theme: cosmo
bibliography: references.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  message = FALSE,
  warning = FALSE,
  fig.width = 10,
  fig.height = 6
)

# Load required packages
library(ggplot2)

# Load results
results <- readRDS("../data/processed/rir_velocity_replication_results.rds")
data <- results$data
```

## The Question

Imagine you're in the middle of a heavy set of squats. Your coach asks: "How many reps do you have left?" If you could answer accurately, you'd have a powerful tool for managing training intensity and fatigue.

This is where **Repetitions in Reserve (RIR)** comes in---a way to quantify how close you are to failure. But can we do better than guessing? Can we use **objective measurements** like bar velocity to predict RIR?

## The Study

Jukic et al. (2024) investigated whether the relationship between bar velocity and RIR could be used for training monitoring and prescription. They compared:

1. **General models**: One equation for everyone
2. **Individual models**: Personalized equations for each lifter

Their key findings:
- Individual models explain about **2x more variance** than general models
- Polynomial (curved) relationships fit better than linear ones
- Prediction accuracy is acceptable for practical use

## Our Data

We're analyzing data from `r results$summary$n_participants` resistance-trained individuals performing back squats at three intensities:

```{r participant-summary}
#| label: tbl-participants
#| tbl-cap: "Participant Characteristics"

summary_df <- data.frame(
  Metric = c("Participants", "Male", "Female",
             "Observations", "Velocity Range (m/s)",
             "RIR Range", "Relative Strength (1RM/BW)"),
  Value = c(
    results$summary$n_participants,
    round(results$summary$n_male),
    round(results$summary$n_female),
    results$summary$n_observations,
    paste(round(results$summary$velocity_range, 2), collapse = " - "),
    paste(results$summary$rir_range, collapse = " - "),
    round(results$summary$mean_relative_strength, 2)
  )
)

knitr::kable(summary_df, col.names = c("", ""))
```

## The Velocity-RIR Relationship

As you get closer to failure, your bar speed slows down. This creates a relationship we can model:

```{r fig-velocity-rir}
#| label: fig-scatter
#| fig-cap: "Velocity-RIR relationship across all participants and loads"

# Create velocity-RIR scatter plot
ggplot(data, aes(x = mean_velocity, y = rir, color = set_type)) +
  geom_point(alpha = 0.3, size = 1) +
  geom_smooth(method = "lm", formula = y ~ poly(x, 2), se = FALSE, size = 1.2) +
  facet_wrap(~set_type, labeller = labeller(set_type = c(
    RTF70 = "70% 1RM",
    RTF80 = "80% 1RM",
    RTF90 = "90% 1RM"
  ))) +
  labs(
    x = "Mean Velocity (m/s)",
    y = "Repetitions in Reserve",
    color = "Load"
  ) +
  theme_minimal() +
  theme(
    legend.position = "none",
    strip.text = element_text(face = "bold", size = 12)
  ) +
  scale_color_manual(values = c("#E69F00", "#56B4E9", "#009E73"))
```

**What you're seeing**: Each point is one repetition. As velocity decreases (moving left), RIR decreases (you're closer to failure). The curves show polynomial fits for each load.

## General vs Individual Models

Here's where it gets interesting. A "general" model uses everyone's data to create one equation. An "individual" model creates a unique equation for each person.

```{r model-comparison}
#| label: tbl-models
#| tbl-cap: "Model Fit Comparison: General vs Individual"

comparison_df <- data.frame(
  `Model Type` = c("General (Polynomial)", "Individual (Polynomial)"),
  `Median R²` = c(
    round(results$comparison$general_r2, 3),
    round(results$comparison$individual_r2, 3)
  ),
  `Interpretation` = c(
    "Explains ~50% of variance",
    "Explains ~88% of variance"
  )
)

knitr::kable(comparison_df, col.names = c("Model Type", "Median R²", "Interpretation"))
```

**The takeaway**: Individual models explain **`r round(results$comparison$improvement_factor, 1)`x more variance** than general models. This means personalized equations are much better at predicting your RIR.

## Why Does This Matter?

### For Athletes and Coaches

If you can accurately predict RIR from velocity:

1. **Auto-regulate training**: Stop a set when velocity indicates 2 RIR instead of guessing
2. **Manage fatigue**: Track velocity loss across a session to monitor accumulated fatigue
3. **Optimize intensity**: Ensure you're training at the intended proximity to failure

### For Researchers

The strong individual relationships suggest:

- **Velocity-based training** is valid for monitoring RIR
- **Individualization** is crucial---one-size-fits-all equations lose precision
- **Simple technology** (velocity trackers) can provide actionable data

## Model Details by Load

```{r load-comparison}
#| label: tbl-loads
#| tbl-cap: "General Model Performance by Load"

load_df <- data.frame(
  Load = c("90% 1RM", "80% 1RM", "70% 1RM"),
  `Linear R²` = c(
    round(results$general_results$RTF90$linear$r_squared, 3),
    round(results$general_results$RTF80$linear$r_squared, 3),
    round(results$general_results$RTF70$linear$r_squared, 3)
  ),
  `Polynomial R²` = c(
    round(results$general_results$RTF90$polynomial$r_squared, 3),
    round(results$general_results$RTF80$polynomial$r_squared, 3),
    round(results$general_results$RTF70$polynomial$r_squared, 3)
  ),
  `RSE (reps)` = c(
    round(results$general_results$RTF90$polynomial$rse, 2),
    round(results$general_results$RTF80$polynomial$rse, 2),
    round(results$general_results$RTF70$polynomial$rse, 2)
  )
)

knitr::kable(load_df, col.names = c("Load", "Linear R²", "Polynomial R²", "RSE (reps)"))
```

**Pattern**: Heavier loads (90% 1RM) have lower RSE because there are fewer possible reps, making prediction easier in absolute terms.

## Individual Model Distribution

```{r fig-individual}
#| label: fig-individual-r2
#| fig-cap: "Distribution of R² values for individual polynomial models"

# Extract R² values from individual results
r2_values <- c()
for (id in names(results$general_results)) {
  if (!is.null(results$general_results[[id]]$polynomial$r_squared)) {
    r2_values <- c(r2_values, results$general_results[[id]]$polynomial$r_squared)
  }
}

# Create histogram using the summary data
individual_r2_median <- results$polynomial_summary$median_r_squared
individual_r2_range <- c(results$polynomial_summary$min_r_squared,
                          results$polynomial_summary$max_r_squared)

# Simple visualization
ggplot(data.frame(x = 1), aes(x = x)) +
  annotate("rect", xmin = 0.2, xmax = 1.0, ymin = 0, ymax = 1,
           fill = "steelblue", alpha = 0.3) +
  annotate("segment", x = individual_r2_median, xend = individual_r2_median,
           y = 0, yend = 1, color = "darkblue", size = 2) +
  annotate("text", x = individual_r2_median, y = 1.1,
           label = paste("Median:", round(individual_r2_median, 2)),
           fontface = "bold") +
  annotate("text", x = individual_r2_range[1], y = 0.5,
           label = paste("Min:", round(individual_r2_range[1], 2))) +
  annotate("text", x = individual_r2_range[2], y = 0.5,
           label = paste("Max:", round(individual_r2_range[2], 2))) +
  scale_x_continuous(limits = c(0, 1.1), breaks = seq(0, 1, 0.2)) +
  labs(x = "R² (Individual Models)", y = "") +
  theme_minimal() +
  theme(
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank(),
    panel.grid.major.y = element_blank(),
    panel.grid.minor.y = element_blank()
  )
```

**Key insight**: Most individual models achieve R² > 0.80, meaning velocity explains over 80% of the variance in RIR for most people.

## Validation Against the Paper

| Metric | Paper Finding | Our Replication | Match? |
|--------|---------------|-----------------|--------|
| General R² | ~0.50-0.60 | `r round(results$comparison$general_r2, 2)` | Yes |
| Individual R² (median) | ~0.85-0.95 | `r round(results$comparison$individual_r2, 2)` | Yes |
| Improvement factor | ~2x | `r round(results$comparison$improvement_factor, 2)`x | Yes |

## Practical Recommendations

Based on these findings:

1. **Build your own velocity-RIR curve**: Perform sets to failure at different loads while tracking velocity. Use this data to create your personalized equation.

2. **Use polynomial models**: The curved relationship captures the data better than a straight line, especially as you approach failure.

3. **Recalibrate periodically**: Your velocity-RIR relationship may shift with training adaptations.

4. **Accept some error**: Even good individual models have ~1 rep error. Use velocity as a guide, not gospel.

## Technical Notes

This analysis used:
- **R6 classes** for clean, object-oriented code
- **Linear and polynomial regression** for model fitting
- **Cross-validation** (Day 1 → Day 2 prediction) for practical validity

Data source: [OSF Repository](https://osf.io/5ejcp/)

## References

Jukic, I., Prnjak, K., Helms, E. R., & McGuigan, M. R. (2024). Modeling the repetitions-in-reserve-velocity relationship: A valid method for resistance training monitoring and prescription, and fatigue management. *Experimental Physiology*, 109(2), 193-206.
